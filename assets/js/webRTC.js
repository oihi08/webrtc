/**
 * webRTC - webRTC prototype.
 * @version v0.1.1
 * @link    
 * @author   ()
 * @license 
 */
(function(){var ICE_SERVERS,OPTIONS,SDPCONTRAINS,SOCKET_URL,events,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};ICE_SERVERS={iceServers:[{url:navigator.mozGetUserMedia?"stun:stun.services.mozilla.com":navigator.webkitGetUserMedia?"stun:stun.l.google.com:19302":"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"},{url:"stun:23.21.150.121"},{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"}]},OPTIONS={optional:[{RtpDataChannels:!0}]},SDPCONTRAINS={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},events=["offer","answer","ice","connected","hangUp","error"],SOCKET_URL="http://localhost:8008",window.webRTC=function(){function webRTC(){this._answer=__bind(this._answer,this),this._offer=__bind(this._offer,this),this._hangUp=__bind(this._hangUp,this),this._connected=__bind(this._connected,this),this._ice=__bind(this._ice,this),this.onRemoteStream=__bind(this.onRemoteStream,this);var event,_i,_len;for($("#login").click(function(_this){return function(){return _this.login()}}(this)),$("#call").click(function(_this){return function(){var friend;return _this._getCamera(friend=!0)}}(this)),$("#hangup").click(function(_this){return function(){return _this.hangup()}}(this)),this.initialize(),this.socket=io.connect(SOCKET_URL),this.peer=new window.webkitRTCPeerConnection(ICE_SERVERS,OPTIONS),this.peer.onicecandidate=function(_this){return function(ice){return ice.candidate&&!_this.offerer?(_this.peer.addIceCandidate(_this._iceCandidate(ice.candidate)),_this.socket.emit("ice",_this.connected_user,ice)):void 0}}(this),_i=0,_len=events.length;_len>_i;_i++)event=events[_i],this.socket.on(event,this["_"+event])}return webRTC.prototype.initialize=function(){return this.localVideo=document.getElementById("localVideo"),this.remoteVideo=document.getElementById("remoteVideo"),localStorage.clear(),this.connected=!1,this.connected_user=null},webRTC.prototype.login=function(){var session;return session=$("#user").val(),localStorage.setItem("session",session),this.socket.emit("open",session)},webRTC.prototype.hangup=function(){return this.socket.emit("hangUp",this._getUserInLocalStorage("friend")),this._close()},webRTC.prototype.offer=function(user){return this.offerer=!0,this.peer.createOffer(function(_this){return function(description){return _this.peer.setLocalDescription(description),_this.socket.emit("offer",user,description)}}(this),null,SDPCONTRAINS)},webRTC.prototype.accept=function(user,remote_description){return this.offerer=!1,this.peer.setRemoteDescription(this._sessionDescription(remote_description)),this.peer.createAnswer(function(_this){return function(description){return _this.peer.setLocalDescription(description),_this.socket.emit("answer",user,description)}}(this),null,SDPCONTRAINS)},webRTC.prototype.onRemoteStream=function(remote_stream){return $(this.remoteVideo).attr("src",window.URL.createObjectURL(remote_stream)),$(this.remoteVideo).addClass("active")},webRTC.prototype._sessionDescription=function(remote){var session_description;return new(session_description=RTCSessionDescription||mozRTCSessionDescription)(remote)},webRTC.prototype._iceCandidate=function(candidate){var ice_candidate;return new(ice_candidate=window.mozRTCIceCandidate||window.RTCIceCandidate)(candidate)},webRTC.prototype._ice=function(ice){return this.offerer&&ice.candidate?this.peer.addIceCandidate(this._iceCandidate(ice.candidate)):void 0},webRTC.prototype._connected=function(friend){return this.connected=!0,this._getUserInLocalStorage("friend")?void 0:(localStorage.setItem("friend",friend),this.socket.emit("connected",this._getUserInLocalStorage("session")))},webRTC.prototype._hangUp=function(){return $(this.remoteVideo).removeClass("active"),this._close()},webRTC.prototype._offer=function(_at_message){return this.message=_at_message,this.connected_user=this.message.user,$(this.localVideo).addClass("active"),this.peer.info=this.message,this._getCamera()},webRTC.prototype._answer=function(data){return this.peer.setRemoteDescription(this._sessionDescription(data.description))},webRTC.prototype._error=function(error){return console.error("[ERROR] :: ",error)},webRTC.prototype._getUserInLocalStorage=function(user){return localStorage.getItem(user)},webRTC.prototype._getCamera=function(friend){return null==friend&&(friend=null),navigator.webkitGetUserMedia?navigator.webkitGetUserMedia({video:!0,audio:!0},function(_this){return function(_at_local_stream){return _this.local_stream=_at_local_stream,$(_this.localVideo).attr("muted",!0).attr("src",window.URL.createObjectURL(_this.local_stream)),$(_this.localVideo).addClass("active"),_this.peer.addStream(_this.local_stream),_this.peer.onaddstream=function(event){return _this.onRemoteStream(event.stream)},friend?_this.offer(_this._getUserInLocalStorage("friend")):_this.accept(_this.peer.info.user,_this.peer.info.description)}}(this),function(error){return console.log("error",error)}):void 0},webRTC.prototype._close=function(){return this.peer&&(this.peer.info=null),this.local_stream=null,$(this.localVideo).attr("src",null),$(this.remoteVideo).attr("src",null),$(this.localVideo).stop(),$(this.remoteVideo).stop(),$(this.localVideo).removeClass("active")},webRTC}()}).call(this);